name: Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Tag or ref to build (e.g., v0.10.0). Defaults to latest tag."
        required: false
        type: string
  workflow_call:
    inputs:
      ref:
        description: "Tag to build (e.g., v0.10.0)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: CLI Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Determine ref to build
        id: ref
        run: |
          if [ -n "${{ inputs.ref }}" ]; then
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}

      - name: Extract version from ref
        id: version
        run: |
          REF="${{ steps.ref.outputs.ref }}"
          # Extract version from tag (e.g., refs/tags/v0.10.0 -> 0.10.0, or v0.10.0 -> 0.10.0)
          VERSION=$(echo "$REF" | sed 's|refs/tags/||' | sed 's|^v||')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build workspace
        run: bun run build
        env:
          WORKOS_API_KEY: ${{ secrets.WORKOS_API_KEY }}

      - name: Build binaries
        run: bun run build:binaries
        working-directory: apps/cli
        env:
          WORKOS_CLIENT_ID: ${{ secrets.WORKOS_CLIENT_ID }}

      - name: Verify binary version
        run: |
          cd apps/cli/dist
          tar -xzf dt-linux-amd64.tar.gz

          # Get version from package.json
          PKG_VERSION=$(jq -r .version ../package.json)

          # Get version from binary - filter for clean semver line (ignore debug output from dotenv etc)
          # The version command outputs just the version number on its own line
          BINARY_OUTPUT=$(./dt-linux-amd64 version 2>/dev/null || true)
          echo "Full binary output:"
          echo "$BINARY_OUTPUT"
          echo "---"

          # Extract the line that is ONLY a semver (no other text)
          BINARY_VERSION=$(echo "$BINARY_OUTPUT" | grep -xE '[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?' | head -1 || echo "")

          echo "Binary version: $BINARY_VERSION"
          echo "Package version: $PKG_VERSION"

          if [ -z "$BINARY_VERSION" ]; then
            echo "ERROR: Could not extract version from binary output"
            exit 1
          fi

          if [ "$BINARY_VERSION" != "$PKG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi

          echo "Version verified: $BINARY_VERSION"
          rm dt-linux-amd64

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums
        run: |
          cosign sign-blob \
            --output-certificate=apps/cli/dist/checksums.txt.pem \
            --output-signature=apps/cli/dist/checksums.txt.sig \
            --yes \
            apps/cli/dist/checksums.txt

      - name: Upload to Blob
        run: bun run upload:binaries
        working-directory: apps/cli
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: |
            apps/cli/dist/*.tar.gz
            apps/cli/dist/*.zip
            apps/cli/dist/checksums.txt
            apps/cli/dist/checksums.txt.sig
            apps/cli/dist/checksums.txt.pem

      - name: Verify install from Blob
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          echo "Testing install of $VERSION from Blob..."

          # Test direct download and checksum
          curl -fsSL "https://detent.sh/api/cli/${VERSION}/checksums.txt" -o /tmp/checksums.txt
          curl -fsSL "https://detent.sh/api/cli/${VERSION}/dt-linux-amd64.tar.gz" -o /tmp/dt.tar.gz

          # Verify checksum
          EXPECTED=$(grep "dt-linux-amd64.tar.gz" /tmp/checksums.txt | cut -d' ' -f1)
          ACTUAL=$(sha256sum /tmp/dt.tar.gz | cut -d' ' -f1)

          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "ERROR: Checksum mismatch after upload!"
            echo "Expected: $EXPECTED"
            echo "Actual: $ACTUAL"
            exit 1
          fi

          # Extract and verify version
          tar -xzf /tmp/dt.tar.gz -C /tmp
          INSTALLED_VERSION=$(/tmp/dt-linux-amd64 version | head -1)
          echo "Installed version: $INSTALLED_VERSION"

          # Verify manifest updated
          MANIFEST_LATEST=$(curl -fsSL "https://detent.sh/api/cli/manifest.json" | grep -o '"latest":"[^"]*"' | cut -d'"' -f4)
          echo "Manifest latest: $MANIFEST_LATEST"

          if [ "$MANIFEST_LATEST" != "$VERSION" ]; then
            echo "WARNING: Manifest not yet updated (may be caching)"
          fi

          echo "Install verification passed!"
